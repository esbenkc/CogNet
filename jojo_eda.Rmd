---
title: "JoJo Graph Fun"
author: "JoJo Rystr√∏m"
date: "11/5/2021"
output: html_document
---
```{r}
pacman::p_load(tidyverse, tidygraph, fastnet, lubridate, reldist)
```

# Helper functions
```{r}
create_graph <- function(dat) {
  vertices <- tibble(name=unique(c(dat$from, dat$to)))
  edges <- dat
  
  tbl_graph(vertices, edges, directed = F)
}

calc_entropy <- function(graph_obj) {
  metric.degree.entropy(from.igraph(graph_obj))
}

get_edge_date <- function(g) {
  g %>% 
    activate(edges) %>% 
    distinct(date) %>% 
    pull()
}

entropy_per_date <- function(graph) {
  entropy <- calc_entropy(graph)
  date <- get_edge_date(graph)
  tibble(date=date, entropy=entropy)
}

create_pair_key <- function(a, b) {
  apply(cbind(a, b), 1, function(x) paste(sort(x), collapse=" "))
}
add_pairs <- function(graph) {
   graph %>%
    activate(edges) %>%
    as_tibble() %>%
    mutate(pair_key = create_pair_key(to, from))
}

calc_friendship_strength <- function(graph) {
   graph %>% 
    add_pairs %>% 
    group_by(pair_key, date) %>% 
    summarise(pair_weight = sum(weight))
}


calc_gini_per_day <- function(graph) {
  graph %>% 
    calc_friendship_strength %>% 
    summarise(gini_coef = gini(pair_weight), date = first(date))
}



```


# Loading data
```{r}
rawdat <- read_csv("tidy_data.csv")

dat <- rawdat %>% 
  filter(from != to) %>% 
  mutate(datetime = lubridate::as_datetime(timestamp/1000))

dat
```

```{r}
pacman::p_load(tidyverse, network, tidygraph, lubridate, ggraph, netrankr, extrafont, seriation, NetSwan, fastnet)


## CHANGE UNIT HERE
unit="week"



dat <- rawdat %>% 
  mutate(timestamp = lubridate::as_datetime(timestamp/1000),
         date = round_date(timestamp, unit=unit),
         from = as.character(from),
         to = as.character(to)) %>% 
  filter(from!=to)

start <- as.Date(range(dat$timestamp)[1]) %>% round_date(unit=unit)
end <- as.Date(range(dat$timestamp)[2]) %>% round_date(unit=unit)

current <- start

sum_dat <- tibble()

while(current <= end){
  
  current_dat <- dat %>% 
    filter(date == round_date(current, unit=unit))
  
  vertices <- tibble(name=unique(c(dat$from, dat$to)))
  edges <- current_dat
  
  graph <- tbl_graph(vertices, edges, directed = F)
  
  
  # Insert specific output measures here
  graph <- graph %>%  
    activate(nodes) %>% 
    mutate(centrality_degreein = centrality_degree(weights=NULL, mode="in", loops=FALSE, normalized=FALSE),
           connectivity_impact = node_connectivity_impact(),
           coreness = node_coreness(mode = "out"),
           eccentricity = node_eccentricity(mode = "out"))
  
  
  node_data <- graph %>% 
    activate(nodes) %>% 
    as_tibble()
  
  node_data <- node_data %>% 
    cbind(date=rep(current %>% round_date(unit=unit), nrow(node_data)))
  
  sum_dat <- sum_dat %>% 
    rbind(node_data)
  
  current <- current + duration(1, unit)
}

#sum_dat %>% write_csv(paste0("node_measures_", unit, ".csv"))

```

## Calculating entropy
```{r}
graph_list <- dat %>% 
  group_split(date) %>% 
  map(create_graph) 

entropy_df <- graph_list %>% 
  map_dfr(entropy_per_date)


entropy_df %>% 
  mutate(date = as.Date(date)) %>% 
  ggplot(aes(x=date, y=entropy)) + 
  geom_line() + 
  geom_vline(xintercept=as.Date("2020-03-11"), colour="red") + 
  geom_smooth() + 
  theme_minimal()
```

## Calculating GINI-coefficient
```{r}
gini_df <- graph_list %>% 
  map_dfr(calc_gini_per_day)


gini_df %>% 
  mutate(date = as.Date(date)) %>% 
  ggplot(aes(x=date, y=gini_coef)) + 
  geom_line() + 
  geom_vline(xintercept=as.Date("2020-03-11"), colour="red") + 
  geom_smooth() + 
  theme_minimal()
```
### The power of friendship
```{r}
calc_friendship_strength(test_graph)


graph <- full_graph

pair_df <- add_pairs(full_graph)

pair_df %>% 
  dplyr::group_by(pair_key, date) %>% 
  summarise(friendship = sum(weight)) %>% 
  mutate(date = as.Date(date)) %>% 
  ggplot(aes(log(friendship))) +
  geom_density()
```

