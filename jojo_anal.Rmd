---
title: "Soccult anal"
author: "JoJo Rystr√∏m"
date: "16/5/2021"
output: html_document
---

## Loading libries
```{r}
pacman::p_load(tidyverse, brms, job)
```

```{r}
rawdat <- read_csv("brms_model_data.csv")
```

```{r}
dat %>% 
  ggplot(aes(x=new_cons)) + 
  geom_histogram()

dat %>% 
  ggplot(aes(x=week, y=log(new_cons))) + 
  geom_point() + 
  geom_smooth()
```

```{r}
dat <- rawdat %>% 
  mutate(timecol = as.integer(as.factor(week)))

dat %>% 
  filter(new_cons > 0 ) %>% 
  summarise(mean(log(new_cons)), sd(log(new_cons)))

m0_f <- bf(new_cons ~ 0 + timecol + lockdown*pagerank*trans + (1 | id))


m1_f <- bf(new_cons ~ 0 + timecol + lockdown + lockdown:pagerank + lockdown:trans + (1 + timecol | id))

get_prior(m1_f, data=dat, family=negbinomial())

m0_priors <- c(
  prior(normal(0, 0.01), class=b), 
  prior(normal(0, 0.01), class=sd), 
  prior(gamma(0.01, 0.01), class=shape),
  prior(lkj(0.3), class=cor)
)
 
m0_prior_model <- brm(
  m1_f,
  dat,
  family=negbinomial(),
  prior=m0_priors,
  sample_prior = "only",
  cores = 2,
  chains = 2,
  backend = "cmdstanr", 
  control = list(adapt_delta = 0.99, max_treedepth=20))

pp_check(m0_prior_model, nsamples=100)

job::job(brm_result = {
  fit = update(
    m0_prior_model,
    sample_prior = T,
    cores = 2,
    chains = 2,
    backend = "cmdstanr"
  ) 
  pos_check =  pp_check(m0_testy, nsamples = 100)
})

summary(m0_testy)
hypothesis(m0_testy, "lockdownTRUE < lockdownFALSE")
hypothesis(m0_testy, "abs(lockdownTRUE:pagerank) > 0")
```

```{r}
summary(brm_result$fit)
brm_result$pos_check
```

